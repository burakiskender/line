{"version":3,"sources":["webpack:///webpack/bootstrap f9dd0a358a08f27efe09","webpack:///./src/server/server.js","webpack:///external \"uws\"","webpack:///./src/server/connection.js","webpack:///./src/lib/message.js","webpack:///external \"lodash\"","webpack:///external \"node-uuid\"","webpack:///external \"events\"","webpack:///./src/server/rooms.js"],"names":["Server","options","rooms","port","server","bindEvents","Promise","resolve","reject","err","on","onConnection","bind","socket","connection","emit","module","exports","_","uuid","Connection","promiseCallbacks","onMessage","onError","onClose","onPing","onPong","data","flags","message","parse","id","event","payload","failed","assign","Error","done","isObject","name","response","send_","error","code","removeFromAll","forEach","callbacks","joinRoom","roomName","add","remove","getRoomsOf","eventName","messageId","setId","then","send","toString","Message","raw","JSON","v4","isUndefined","isEmpty","stringify","Rooms","keys","filter","connections","room"],"mappings":"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","file":"server.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId])\n \t\t\treturn installedModules[moduleId].exports;\n\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\texports: {},\n \t\t\tid: moduleId,\n \t\t\tloaded: false\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.loaded = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(0);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap f9dd0a358a08f27efe09","import {Server as WebSocketServer} from 'uws';\nimport Connection from './connection';\nimport Rooms from './rooms';\nimport {EventEmitter} from 'events';\n\n\nclass Server extends EventEmitter {\n\tconstructor(options) {\n\t\tsuper();\n\t\tthis.rooms = new Rooms();\n\t\tthis.options = options;\n\t}\n\n\tstart() {\n\t\tif (!this.options.port) {\n\t\t\tthis.server = new WebSocketServer(this.options);\n\t\t\tthis.bindEvents();\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis.server = new WebSocketServer(this.options, err => {\n\t\t\t\tif (err) return reject(err);\n\t\t\t\tthis.bindEvents();\n\t\t\t\tresolve();\n\t\t\t});\n\t\t})\n\t}\n\n\tbindEvents() {\n\t\tthis.server.on('connection', this.onConnection.bind(this));\n\t}\n\n\tonConnection(socket) {\n\t\tconst connection = new Connection(socket, this);\n\t\tthis.emit('connection', connection);\n\t}\n\n\n}\n\nmodule.exports = Server;\n\n\n// WEBPACK FOOTER //\n// ./src/server/server.js","module.exports = require(\"uws\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"uws\"\n// module id = 1\n// module chunks = 0","import Message from '../lib/message';\nimport {EventEmitter} from 'events';\nimport * as _ from 'lodash';\nimport * as uuid from 'node-uuid';\n\n\nclass Connection extends EventEmitter {\n\tconstructor(socket, server) {\n\t\tsuper();\n\n\t\tthis.socket = socket;\n\t\tthis.server = server;\n\n\t\tthis.promiseCallbacks = {};\n\t\t// this.id = uuid.v4();\n\t\tthis.socket.on('message', this.onMessage.bind(this));\n\t\tthis.socket.on('error', this.onError.bind(this));\n\t\tthis.socket.on('close', this.onClose.bind(this));\n\t\tthis.socket.on('ping', this.onPing.bind(this));\n\t\tthis.socket.on('pong', this.onPong.bind(this));\n\t\t//this.socket.on('open', this.onOpen.bind(this));\n\t}\n\n\n// line\n// \t.send('asd', payload)\n// \t.then(null => {\n// \t\t// 123\n// \t});\n\n\tonMessage(data, flags) {\n\t\tconst message = Message.parse(data);\n\t\tif (!message.options.id)\n\t\t\treturn this.emit(message.event, message.payload, message);\n\n\t\tif (message.event == '_ack') {\n\t\t\tconst {resolve, reject} = this.promiseCallbacks[message.id];\n\n\t\t\tif (message.options.failed) {\n\t\t\t\tconst err = _.assign(new Error(), err);\n\t\t\t\treject(err);\n\t\t\t} else {\n\t\t\t\tresolve(message.payload);\n\t\t\t}\n\n\t\t\tdelete this.promiseCallbacks[message.id];\n\t\t\treturn;\n\t\t}\n\n\t\tconst done = (err, payload) => {\n\t        if (_.isObject(err) && err instanceof Error && err.name == 'Error')\n\t            err = {message: err.message, name: 'Error'};\n\n\t\t\tconst response = err ? new Message('_ack', err, {failed: true}) : new Message('_ack', payload);\n\t\t\tthis.send_(response);\n\t\t};\n\n\t\tthis.emit(message.event, message.payload, done, message);\n\t}\n\n\tonError(error) {\n\t\tthis.emit('error', error);\n\t}\n\n\tonClose(code, message) {\n\t\tthis.server.rooms.removeFromAll(this);\n\n\t\t_.forEach(this.promiseCallbacks, (callbacks) => {\n\t\t\tcallbacks.reject(new Error('Socket connection closed!'));\n\t\t});\n\t\tthis.promiseCallbacks = {};\n\n\t\tthis.emit('close', code, message);\n\t}\n\n\tonPing(data, flags) {\n\t\tthis.emit('ping', data, flags);\n\t}\n\n\tonPong(data, flags) {\n\t\tthis.emit('pong', data, flags);\n\t}\n\n\tonOpen() {\n\t\tthis.joinRoom('/');\n\t\tthis.emit('open');\n\t}\n\n\n\tjoinRoom(roomName) {\n\t\tthis.server.rooms.add(roomName, this);\n\t}\n\n\n\tleaveRoom(roomName) {\n\t\tthis.server.rooms.remove(roomName, this);\n\t}\n\n\tgetRooms() {\n\t\tthis.server.rooms.getRoomsOf(this);\n\t}\n\n\tsend(eventName, payload) {\n\t\tconst message = new Message(eventName, payload);\n\t\tconst messageId = message.setId();\n\t\treturn this\n\t\t\t.send_(message)\n\t\t\t.then(_ => {\n\t\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\t\tthis.promiseCallbacks[messageId] = {resolve, reject};\n\t\t\t\t});\n\t\t\t});\n\t}\n\n\tsend_(message) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis.socket.send(message.toString(), err => {\n\t\t\t\tif (err) return reject(err);\n\t\t\t\tresolve();\n\t\t\t});\n\t\t});\n\t}\n}\n\nmodule.exports = Connection;\n\n\n\n// WEBPACK FOOTER //\n// ./src/server/connection.js","import * as _ from 'lodash';\nimport * as uuid from 'node-uuid';\n\n\nexport default class Message {\n\tstatic parse(raw) {\n\t\ttry {\n\t\t\tconst data = JSON.parse(raw);\n\t\t\treturn new Message(data.event, data.payload, data.options);\n\t\t} catch(err) {\n\t\t\tthrow new Error(`Could not parse message.`);\n\t\t}\n\t}\n\n\tconstructor(event, payload, options = {}) {\n\t\tthis.event = event;\n\t\tthis.payload = payload;\n\t\tthis.options = options;\n\t}\n\n\tsetId(id) {\n\t\tif (!id)\n\t\t\tid = uuid.v4();\n\t\tthis.options.id = id;\n\t\treturn id;\n\t}\n\n\ttoString() {\n\t\ttry {\n\t\t\tconst data = {event: this.event};\n\n\t\t\tif (!_.isUndefined(this.payload))\n\t\t\t\tdata.payload = this.payload;\n\n\t\t\tif (!_.isEmpty(this.options))\n\t\t\t\tdata.options = this.options;\n\n\t\t\treturn JSON.stringify(data);\n\t\t} catch(err) {\n\t\t\tthrow new Error(`Could not stringify message.`);\n\t\t}\n\t}\n}\n\n\n// WEBPACK FOOTER //\n// ./src/lib/message.js","module.exports = require(\"lodash\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"lodash\"\n// module id = 4\n// module chunks = 0","module.exports = require(\"node-uuid\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"node-uuid\"\n// module id = 5\n// module chunks = 0","module.exports = require(\"events\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"events\"\n// module id = 6\n// module chunks = 0","import * as _ from 'lodash';\n\n\nexport default class Rooms {\n\tconstructor() {\n\t\tthis.rooms = {'/': {}};\n\t}\n\n\tadd(roomName, connection) {\n\t\tif(!this.rooms[roomName])\n\t\t\tthis.rooms[roomName] = {};\n\n\t\tthis.rooms[roomName][connection.id] = connection;\n\t}\n\n\tremove(roomName, connection) {\n\t\tif(!this.rooms[roomName])\n\t\t\treturn;\n\n\t\tdelete this.rooms[roomName][connection.id];\n\n\t\tif (roomName != '/' && _.isEmpty(this.rooms[roomName]))\n\t\t\tdelete this.rooms[roomName];\n\t}\n\n\tgetRoomsOf(connection) {\n\t\treturn _.keys(_.filter(this.rooms, connections => connections[connection.id]));\n\t}\n\n\tremoveFromAll(connection) {\n\t\tconst rooms = this.getRoomsOf(connection);\n\t\t_.forEach(rooms, room => this.remove(room, connection));\n\t}\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/server/rooms.js"],"sourceRoot":""}