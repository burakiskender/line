module.exports=function(e){function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}var t={};return n.m=e,n.c=t,n.i=function(e){return e},n.d=function(e,n,t){Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:t})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},n.p="",n(n.s=20)}([function(e,n){e.exports=require("event-emitter-extra/dist/commonjs.modern")},function(e,n){e.exports=require("lodash/forEach")},function(e,n){e.exports=require("debug")},function(e,n,t){"use strict";function o(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function r(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function i(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}var s=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}(),a=t(16),c=t(6),u=t(15),l=t(18),d=t(4),h=d.generateDummyId,f=t(0),v=function(e){function n(e){var t=e.name,i=e.payload,s=e.id,a=e.err;o(this,n);var c=r(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return c.name=t,c.payload=i,c.id=s,c.err=a,c.isResponded_=!1,c}return i(n,e),s(n,null,[{key:"parse",value:function(e){try{var t=JSON.parse(e);return new n({name:t.n,payload:t.p,err:t.e,id:t.i})}catch(e){throw new Error("Could not parse message.")}}}]),s(n,[{key:"setId",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:h();return this.id=e,e}},{key:"createResponse",value:function(e,t){return new n({name:"_r",payload:t,err:e,id:this.id})}},{key:"resolve",value:function(e){var n=this;return a(this.id)?console.warn("[line] A message without an id cannot be resolved."):this.isResponded_?console.warn("[line] This message has already been ended."):c(e)&&u(e.then)?void e.then(function(t){n.isResponded_=!0,n.emit("resolved",e)}).catch(function(e){n.isResponded_=!0,n.emit("rejected",e)}):(this.isResponded_=!0,void this.emit("resolved",e))}},{key:"reject",value:function(e){return a(this.id)?console.warn("[line] A message without an id cannot be rejected."):this.isResponded_?console.warn("[line] This message has already been ended."):(this.isResponded_=!0,void this.emit("rejected",e))}},{key:"toString",value:function(){try{var e={n:this.name};return a(this.payload)||(e.p=this.payload),a(this.id)||(e.i=this.id),a(this.err)||(e.e=this.err),JSON.stringify(e)}catch(e){throw new Error("Could not stringify message.")}}},{key:"dispose",value:function(){var e=this,n=this.eventNames();n.forEach(function(n){return e.removeAllListeners(n)})}}]),n}(f);v.Names={RESPONSE:"_r",HANDSHAKE:"_h",PING:"_p"},v.ReservedNames=l(v.Names),e.exports=v},function(e,n,t){"use strict";function o(e){return new Promise(function(n){return setTimeout(function(e){return n()},e)})}function r(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t={maxDelay:160,maxCount:0,initialDelay:3,increaseFactor:2};n=s(t,n);var r=void 0,i=1,a=n.initialDelay,c=function t(){return e().catch(function(e){if(i++,a*=n.increaseFactor,0!=n.maxCount&&i>n.maxCount)throw r&&clearTimeout(r),e;return o(1e3*a/2).then(function(e){return t()})})};return c()}function i(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:4;return("0000"+(Math.random()*Math.pow(36,e)<<0).toString(36)).slice(-e)}var s=t(5);e.exports={promiseDelay:o,retry:r,generateDummyId:i}},function(e,n){e.exports=require("lodash/assign")},function(e,n){e.exports=require("lodash/isObject")},function(e,n,t){"use strict";function o(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function r(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function i(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}var s=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}(),a=(t(4),t(3)),c=t(0),u=t(5),l=t(1),d=t(6),h=t(13),f=t(10),v=t(19),p=t(2)("line:server:connection"),m=function(e){function n(e,t){o(this,n);var i=r(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return i.id=v.v4(),p("Creating connection with id "+i.id+" ..."),i.socket=e,i.server=t,i.deferreds_={},i.state=n.States.OPEN,i.handshakeResolved_=!1,i.socket.on("message",i.onMessage_.bind(i)),i.socket.on("error",i.onError_.bind(i)),i.socket.on("close",i.onClose_.bind(i)),i.autoPing_=t.options.pingInterval>0?h(function(){return i.state!=n.States.OPEN?void p("Not auto-pinging, connection state ("+i.state+") is not open"):void i.ping().then(function(){p("Auto-ping successful"),t.options.pingInterval>0&&i.state==n.States.OPEN&&i.autoPing_()}).catch(function(e){p("Auto-ping failed: "+e.toString())})},t.options.pingInterval):function(){},i}return i(n,e),s(n,[{key:"onMessage_",value:function(e,t){var o=this,r=a.parse(e);return p('Native "message" event recieved: '+e),this.autoPing_(),this.emit(n.Events.MESSAGE,e),r.id||a.ReservedNames.indexOf(r.name)!=-1?r.name==a.Names.HANDSHAKE?this.onHandshake_(r):r.name==a.Names.PING?this.onPing_(r):r.name==a.Names.RESPONSE&&this.deferreds_[r.id]?this.onResponse_(r):(r.once("resolved",function(e){p("Message #"+r.id+" is resolved, sending response..."),o.send_(r.createResponse(null,e)),r.dispose()}),r.once("rejected",function(e){p("Message #"+r.id+" is rejected, sending response..."),d(e)&&e instanceof Error&&(e=u({message:e.message,name:e.name},e)),o.send_(r.createResponse(e)),r.dispose()}),void this.emit(r.name,r)):this.emit(r.name,r)}},{key:"onHandshake_",value:function(e){var t=this;p("Handshake message recieved: "+e),e.once("resolved",function(o){p("Handshake is resolved, sending response..."),t.handshakeResolved_=!0;var r={handshakePayload:o,id:t.id,timeout:t.server.options.timeout,maxReconnectDelay:t.server.options.maxReconnectDelay,initialReconnectDelay:t.server.options.initialReconnectDelay,reconnectIncrementFactor:t.server.options.reconnectIncrementFactor,pingInterval:t.server.options.pingInterval};t.send_(e.createResponse(null,r)).then(function(){p("Handshake resolving response is sent, emitting Handshake OK..."),t.server.rooms.root.add(t),t.emit(n.Events.HANDSHAKE_OK)}).catch(function(e){p('Handshake resolving response could not sent, manually calling "close"...'),console.log("Handshake resolve response failed to send for "+t.id+"."),t.close(4500,e&&e.toString())}).then(function(){e.dispose()})}),e.once("rejected",function(n){p("Handshake is rejected, sending response..."),d(n)&&n instanceof Error&&(n=u({message:n.message,name:"Error"},n)),t.send_(e.createResponse(n)).catch(function(e){p('Handshake rejecting response could not sent, manually calling "close"...'),console.log("Handshake reject response failed to send for "+t.id+".")}).then(function(){t.close(4500,n.message),e.dispose()})}),p('Emitting server\'s "handshake" event...');var o=this.server.emit("handshake",this,e);o||(p("There is no handshake listener, resolving the handshake by default..."),e.resolve())}},{key:"onResponse_",value:function(e){var n=this.deferreds_[e.id];if(e.err){p("Response (rejecting) recieved: "+e);var t=u(new Error,e.err);n.reject(t)}else p("Response (resolving) recieved: "+e),n.resolve(e.payload);delete this.deferreds_[e.id]}},{key:"onPing_",value:function(e){p('Ping request recieved, responding with "pong"...'),this.send_(e.createResponse(null,"pong")).catch(function(e){p("Could not send ping response: "+e),console.log("Ping responce failed to send",e)})}},{key:"onError_",value:function(e){p('Native "error" event recieved, emitting line\'s "error" event: '+e),this.emit(n.Events.ERROR,e),p('And manually calling "close"...'),this.close(4500,e&&e.toString())}},{key:"close",value:function(e,n){this.socket.close(e,n)}},{key:"onClose_",value:function(e,t){return p('Native "close" event recieved with code '+e+": "+t),this.state==n.States.CLOSE?void p("Connection's state is already closed, ignoring..."):(p("Removing connection from all rooms, rejecting all waiting messages..."),this.server.rooms.removeFromAll(this),this.server.rooms.root.remove(this),l(this.deferreds_,function(e){e.reject(new Error("Socket connection closed!"))}),this.deferreds_={},p('Emitting line\'s "close" event...'),this.state=n.States.CLOSE,void this.emit(n.Events.CLOSE,e,t))}},{key:"setId",value:function(e){if(this.handshakeResolved_)throw new Error("Handshake already resolved, you cannot change connection id anymore");if(this.server.getConnectionById(e))throw new Error("Conflict! There is already connection with id newId");this.id=e}},{key:"joinRoom",value:function(e){this.server.rooms.add(e,this)}},{key:"leaveRoom",value:function(e){this.server.rooms.remove(e,this)}},{key:"getRooms",value:function(){return this.server.rooms.getRoomsOf(this)}},{key:"send",value:function(e,n){var t=this,o=new a({name:e,payload:n});return o.setId(),this.send_(o).then(function(e){var n=t.deferreds_[o.id]=new f({onExpire:function(){p("Message #"+o.id+" timeout!"),delete t.deferreds_[o.id]},timeout:t.server.options.timeout});return n})}},{key:"sendWithoutResponse",value:function(e,n){var t=new a({name:e,payload:n});return this.send_(t)}},{key:"send_",value:function(e){var n=this;return new Promise(function(t,o){p("Sending message: "+e),n.socket.send(e.toString(),function(e){return e?o(e):void t()})})}},{key:"ping",value:function(){var e=this;return p("Pinging..."),this.send(a.Names.PING).catch(function(n){throw p("Ping failed: "+n.toString()),e.close(410,new Error("Ping failed, dead connection")),n})}},{key:"close",value:function(e,n){var t=this;return p("Closing the connection..."),new Promise(function(o){t.socket.close(e,n),o()})}}]),n}(c);m.States={OPEN:"open",CLOSE:"close"},m.Events={MESSAGE:"_message",HANDSHAKE_OK:"_handshakeOk",ERROR:"_error",CLOSE:"_close"},e.exports=m},function(e,n,t){"use strict";function o(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}(),i=t(14),s=t(1),a=t(17),c=t(11),u=function(){function e(){o(this,e),this.rooms={},this.root=new c}return r(e,[{key:"add",value:function(e,n){this.rooms[e]||(this.rooms[e]=new c(e)),this.rooms[e].add(n)}},{key:"remove",value:function(e,n){this.rooms[e]&&(this.rooms[e].remove(n),this.rooms[e].getConnectionsCount()||delete this.rooms[e])}},{key:"getRoomsOf",value:function(e){return a(i(this.rooms,function(n){return n.getConnectionById(e.id)}),"name")}},{key:"getRoom",value:function(e){return this.rooms[e]}},{key:"removeFromAll",value:function(e){var n=this,t=this.getRoomsOf(e);s(t,function(t){return n.rooms[t].remove(e)})}}]),e}();e.exports=u},function(e,n){e.exports=require("uws")},function(e,n){"use strict";function t(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var o=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}(),r=function(){function e(){var n=this,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=o.handler,i=void 0===r?function(){}:r,s=o.onExpire,a=void 0===s?function(){}:s,c=o.timeout,u=void 0===c?0:c;t(this,e),this.resolve_=null,this.reject_=null,this.timeout_=null,this.onExpire_=a,this.isFinished_=!1,this.promise=new Promise(function(e,t){n.resolve_=e,n.reject_=t;try{i(n)}catch(e){n.reject(e)}}),u>0&&(this.timeout_=setTimeout(this.expire.bind(this),u))}return o(e,[{key:"resolve",value:function(e){this.isFinished_||(this.isFinished_=!0,this.clearTimeout_(),this.resolve_(e))}},{key:"reject",value:function(e){this.isFinished_||(this.isFinished_=!0,this.clearTimeout_(),this.reject_(e))}},{key:"expire",value:function(){this.isFinished_=!0,this.clearTimeout_(),this.onExpire_(),this.reject_(new Error("Timeout exceed"))}},{key:"then",value:function(){for(var e=arguments.length,n=Array(e),t=0;t<e;t++)n[t]=arguments[t];return this.promise.then.apply(this.promise,n)}},{key:"catch",value:function(){for(var e=arguments.length,n=Array(e),t=0;t<e;t++)n[t]=arguments[t];return this.promise.catch.apply(this.promise,n)}},{key:"clearTimeout_",value:function(){this.timeout_&&(clearTimeout(this.timeout_),this.timeout_=null)}}]),e}();e.exports=r},function(e,n,t){"use strict";function o(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}(),i=t(1),s=t(12),a=t(3),c=function(){function e(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};o(this,e),this.name=n,this.connections=t}return r(e,[{key:"add",value:function(e){this.connections[e.id]=e}},{key:"remove",value:function(e){delete this.connections[e.id]}},{key:"getConnectionById",value:function(e){return this.connections[e]}},{key:"getConnections",value:function(){return s(this.connections)}},{key:"getConnectionsCount",value:function(){return Object.keys(this.connections).length}},{key:"broadcast_",value:function(e){i(this.connections,function(n){n.send_(e)})}},{key:"broadcast",value:function(e,n){var t=new a({name:e,payload:n});i(this.connections,function(e,n){e.send_(t)})}}]),e}();e.exports=c},function(e,n){e.exports=require("lodash/clone")},function(e,n){e.exports=require("lodash/debounce")},function(e,n){e.exports=require("lodash/filter")},function(e,n){e.exports=require("lodash/isFunction")},function(e,n){e.exports=require("lodash/isUndefined")},function(e,n){e.exports=require("lodash/map")},function(e,n){e.exports=require("lodash/values")},function(e,n){e.exports=require("node-uuid")},function(e,n,t){"use strict";function o(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function r(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function i(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}var s=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}(),a=t(9).Server,c=t(7),u=t(8),l=t(0),d=t(2)("line:server"),h=function(e){function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};o(this,n);var t=r(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return t.rooms=new u,t.options=Object.assign({timeout:1e4,maxReconnectDelay:60,initialReconnectDelay:1,reconnectIncrementFactor:1.5,pingInterval:3e4},e),d("Initalizing with options: "+JSON.stringify(t.options)),t}return i(n,e),s(n,[{key:"start",value:function(){var e=this;return this.options.port?new Promise(function(n,t){d('Starting with port "'+e.options.port+'" ...'),e.server=new a(e.options,function(o){return o?(d("Could not start: "+o),t(o)):(e.bindEvents(),void n())})}):(d("Starting without port..."),this.server=new a(this.options),this.bindEvents(),Promise.resolve())}},{key:"stop",value:function(){var e=this;if(!this.server){d("Could not stop server. Server is probably not started, or already stopped.");var n=new Error("Could not stop server. Server is probably not started, or already stopped.");return Promise.reject(n)}return new Promise(function(n){d("Closing and disposing the server..."),e.server.close(),e.server=null,n()})}},{key:"bindEvents",value:function(){d("Binding server events..."),this.server.on("connection",this.onConnection.bind(this)),this.server.on("headers",this.onHeaders.bind(this)),this.server.on("error",this.onError.bind(this))}},{key:"onConnection",value:function(e){var t=this;d('Native "connection" event recieved, creating line connection...');var o=new c(e,this);o.on(c.Events.HANDSHAKE_OK,function(){d('Handshake OK, emitting line\'s "connection" event...'),t.emit(n.Events.CONNECTION,o)})}},{key:"onHeaders",value:function(e){d('Native "headers" event recieved, emitting line\'s "headers" event... ('+e+")"),this.emit(n.Events.HEADERS,e)}},{key:"onError",value:function(e){d('Native "error" event recieved, emitting line\'s "error" event... ('+e+")"),this.emit(n.Events.ERROR,e)}},{key:"getConnections",value:function(){return this.rooms.root.getConnections()}},{key:"getConnectionById",value:function(e){return this.rooms.root.getConnectionById(e)}},{key:"broadcast",value:function(e,n){d('Broadcasting "'+e+'" event...'),this.rooms.root.broadcast(e,n)}},{key:"getRoom",value:function(e){return this.rooms.getRoom(e)}},{key:"getRoomsOf",value:function(e){return this.rooms.getRoomsOf(e)}},{key:"removeFromAllRooms",value:function(e){this.rooms.removeFromAll(e)}}]),n}(l);h.Events={CONNECTION:"connection",HANDSHAKE:"handshake",HEADERS:"headers",ERROR:"error"},e.exports=h}]);
//# sourceMappingURL=server.js.map