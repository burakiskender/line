module.exports=function(e){function t(r){if(n[r])return n[r].exports;var i=n[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,t),i.l=!0,i.exports}var n={};return t.m=e,t.c=n,t.i=function(e){return e},t.d=function(e,t,n){Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=14)}([function(e,t,n){"use strict";function r(e){return new Promise(function(t){return setTimeout(function(e){return t()},e)})}function i(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n={maxDelay:160,maxCount:0,initialDelay:3,increaseFactor:2};t=s(n,t);var i=void 0,o=1,c=t.initialDelay,a=function n(){return e().catch(function(e){if(o++,c*=t.increaseFactor,0!=t.maxCount&&o>t.maxCount)throw i&&clearTimeout(i),e;return r(1e3*c/2).then(function(e){return n()})})};return a()}function o(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:4;return("0000"+(Math.random()*Math.pow(36,e)<<0).toString(36)).slice(-e)}var s=n(8);e.exports={promiseDelay:r,retry:i,generateDummyId:o}},function(e,t){e.exports=require("event-emitter-extra/dist/commonjs.modern")},function(e,t){e.exports=require("lodash/isObject")},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var s=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),c=n(6),a=n(0),u=n(1),l=n(5),h=n(9),d=n(2),f=n(10),p=n(7)("line:client-web"),_=function(e){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"ws://localhost",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};r(this,t);var o=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return o.url=e,o.options=n,o.ws_=null,o.id=null,o.reconnect=!f(n.reconnect)||n.reconnect,o.reconnectDisabled_=!1,o.serverTimeout_=1e4,o.maxReconnectDelay=60,o.initialReconnectDelay=1,o.reconnectIncrementFactor=1.5,o.pingInterval=3e4,o.deferreds_={},o.connectDeferred_=null,o.connectError_=null,o.disconnectDeferred_=null,o.disconnectTimeoutDuration_=3e4,o.disconnectTimeout_=null,o.state=t.States.READY,o.uptimeInterval_=5e3,o.uptimeBuffer_=[],o.uptimeBufferLength_=3e5/o.uptimeInterval_,o.uptimeCheck_=n.keepUptime?setInterval(o.uptimeTick_.bind(o),o.uptimeInterval_):null,o.autoPing_=o.pingInterval>0?h(function(){o.state==t.States.CONNECTED&&o.ping().then(function(){o.pingInterval>0&&o.state==t.States.CONNECTED&&o.autoPing_()}).catch(function(){})},o.pingInterval):function(){},o}return o(t,e),s(t,[{key:"connect",value:function(){var e=this;switch(this.state){case t.States.CONNECTING:return Promise.reject(new Error("Could not connect, already trying to connect to a host..."));case t.States.CONNECTED:return Promise.reject(new Error("Already connected."));case t.States.CLOSING:return Promise.reject(new Error("Terminating an active connecting, try again later."));case t.States.CLOSED:case t.States.READY:return this.connectError_=null,this.connectDeferred_=new l({handler:function(){e.state=t.States.CONNECTING,e.emit(t.Events.CONNECTING),e.reconnectDisabled_=!1,setTimeout(function(t){p('Connecting to "'+e.url+'" ...'),e.ws_=new WebSocket(e.url),e.bindEvents_()},0)}}),this.connectDeferred_;default:return Promise.reject(new Error("Could not connect, unknown state."))}}},{key:"disconnect",value:function(e,n,r){var i=this;switch(this.state){case t.States.ERROR:case t.States.CONNECTED:case t.States.CONNECTING:return p("Disconnecting..."),this.ws_.close(e||1e3,n),p("Websocket closed!"),this.reconnectDisabled_=!r,this.disconnectDeferred_=new l,this.state=t.States.CLOSING,this.disconnectTimeout_&&clearTimeout(this.disconnectTimeout_),this.disconnectTimeout_=setTimeout(function(){p("Disconnect timeout exceeded, force disconnecting..."),i.onClose(new Error("Disconnect timeout exceeded, force disconnecting...")),clearTimeout(i.disconnectTimeout_)},this.disconnectTimeoutDuration_),this.disconnectDeferred_;case t.States.CLOSED:return Promise.reject(new Error("There is no connection to disconnect."));case t.States.CLOSING:return Promise.reject(new Error("Already terminating a connecting, try again later."))}}},{key:"bindEvents_",value:function(){p("Binding native event handlers."),this.ws_.onopen=this.onOpen.bind(this),this.ws_.onclose=this.onClose.bind(this),this.ws_.onerror=this.onError.bind(this),this.ws_.onmessage=this.onMessage.bind(this)}},{key:"unBindEvents_",value:function(){this.ws_&&(p("Unbinding native event handlers."),this.ws_.onopen=function(){},this.ws_.onclose=function(){},this.ws_.onerror=function(){},this.ws_.onmessage=function(){})}},{key:"disposeConnectionPromisses_",value:function(){p("Disposing connection promisses..."),this.connectDeferred_&&(p("Rejecting connect promise..."),this.connectDeferred_.reject(this.connectError_),this.connectDeferred_=null,this.connectError_=null),this.disconnectDeferred_&&(p("Rejecting disconnect promise..."),this.disconnectDeferred_.reject(),this.disconnectDeferred_=null)}},{key:"onOpen",value:function(){var e=this;p('Native "open" event received.'),p("State="+this.state),p("Sending handshake data..."),this.send(c.Names.HANDSHAKE,this.options.handshakePayload).then(function(n){p("Handshake successful."),e.id=n.id,e.serverTimeout_=n.timeout,e.maxReconnectDelay=n.maxReconnectDelay,e.initialReconnectDelay=n.initialReconnectDelay,e.reconnectIncrementFactor=n.reconnectIncrementFactor,e.pingInterval=n.pingInterval,e.connectDeferred_&&(p("Resolving connect promise..."),e.connectDeferred_.resolve(n.handshakePayload),e.connectDeferred_=null,e.connectError_=null),e.state=t.States.CONNECTED,p('Emitting "connected" event...'),e.emit(t.Events.CONNECTED,n.handshakePayload)}).catch(function(n){return p("Handshake failed."),e.connectError_=n,p('Emitting "error" event...'),e.emit(t.Events.ERROR,n),e.disconnect()}).catch(function(e){p("Could not disconnect after handshake failure."),console.log("Could not disconnect after failed handshake",e)})}},{key:"onClose",value:function(e){var n=this;switch(p('Native "close" event reveived.'),p("State="+this.state),this.disconnectTimeout_&&clearTimeout(this.disconnectTimeout_),this.unBindEvents_(),this.id=null,this.ws_=null,p('Emitting "closed" event...'),this.emit(t.Events.CLOSED,e),this.state){case t.States.CLOSING:if(this.state=t.States.CLOSED,this.disconnectDeferred_&&(p("Resolving disconnect promise..."),this.disconnectDeferred_.resolve(),this.disconnectDeferred_=null),this.connectDeferred_&&(p("Rejecting connect promise..."),this.connectDeferred_.reject(this.connectError_||new Error("Connection closed while connecting...")),this.connectDeferred_=null,this.connectError_=null),!this.reconnect||this.retrying_||this.reconnectDisabled_)return;break;case t.States.CONNECTING:if(this.state=t.States.CLOSED,this.disconnectDeferred_&&(p("Rejecting disconnect promise..."),this.disconnectDeferred_.reject(new Error("Already disconnected")),this.disconnectDeferred_=null),!this.reconnect||this.retrying_||this.reconnectDisabled_)return void(this.connectDeferred_&&(p("Rejecting connect promise..."),this.connectDeferred_.reject(this.connectError_),this.connectDeferred_=null,this.connectError_=null));break;default:if(this.state=t.States.CLOSED,this.disconnectDeferred_&&(p("Rejecting disconnect promise..."),this.disconnectDeferred_.reject(new Error("Already disconnected")),this.disconnectDeferred_=null),this.connectDeferred_&&(p("Rejecting connect promise..."),this.connectDeferred_.reject(new Error("Already connected")),this.connectDeferred_=null,this.connectError_=null),!this.reconnect||this.retrying_||this.reconnectDisabled_)return}p("Retrying to connect..."),this.retrying_=!0,a.retry(function(e){return n.connect()},{maxCount:this.maxReconnectDelay,initialDelay:this.initialReconnectDelay,increaseFactor:this.reconnectIncrementFactor}).then(function(e){p("Retry successful."),n.retrying_=!1})}},{key:"onError",value:function(e){p('Native "error" event reveived.'),p("State="+this.state);var n=this.state==t.States.CONNECTING?t.Events.CONNECTING_ERROR:t.Events.ERROR;this.emit(n,e||new Error("Unknown error"))}},{key:"onMessage",value:function(e){var t=this;p('Native "message" event reveived.');var n=c.parse(e.data);if(this.autoPing_(),!n.id&&c.ReservedNames.indexOf(n.name)==-1)return p('Message without response: name="'+n.name+'"'),this.emit(n.name,n);if(n.name==c.Names.PING)return this.onPing_(n);if(n.name==c.Names.RESPONSE&&this.deferreds_[n.id]){var r=this.deferreds_[n.id];if(p('Message response: name="'+n.name+'" id="'+n.id+'"'),n.err){var i=Object.assign(new Error,n.err);r.reject(i)}else r.resolve(n.payload);return void delete this.deferreds_[n.id]}p('Message with response: name="'+n.name+'" id="'+n.id+'"'),n.once("resolved",function(e){p('Client resolving: name="'+n.name+'" id="'+n.id+'"'),t.send_(n.createResponse(null,e)),n.dispose()}),n.once("rejected",function(e){d(e)&&e instanceof Error&&"Error"==e.name&&(e={message:e.message,name:"Error"}),p('Client rejecting: name="'+n.name+'" id="'+n.id+'"'),t.send_(n.createResponse(e)),n.dispose()}),this.emit(n.name,n)}},{key:"onPing_",value:function(e){p("Ping received"),this.send_(e.createResponse(null,"pong")).catch(function(e){console.log("Ping responce failed to send",e)})}},{key:"send",value:function(e,t){var n=this,r=new c({name:e,payload:t});return r.setId(),this.send_(r).then(function(e){var t=n.deferreds_[r.id]=new l({onExpire:function(){delete n.deferreds_[r.id]},timeout:n.serverTimeout_});return t})}},{key:"sendWithoutResponse",value:function(e,t){var n=new c({name:e,payload:t});return this.send_(n)}},{key:"send_",value:function(e){var t=this;return new Promise(function(n){p("Sending message: "+e.toString()),t.ws_.send(e.toString()),n()})}},{key:"ping",value:function(){var e=this,t=this.ws_;return p("Pinging..."),this.send(c.Names.PING).catch(function(n){if(e.ws_!=t)return void p("Auto-ping failed, but socket is also changed, dismissing...");throw p("Auto-ping failed, manually disconnecting..."),e.disconnect(4500,"Auto ping failed",!0),n})}},{key:"uptimeTick_",value:function(){p("•Uptime Tick•"),this.uptimeBuffer_.push(this.state==t.States.CONNECTED),this.uptimeBuffer_.length>this.uptimeBufferLength_&&this.uptimeBuffer_.splice(0,this.uptimeBufferLength_-this.uptimeBuffer_.length)}},{key:"getUptime",value:function(){return this.options.keepUptime?0==this.uptimeBuffer_.length?0:this.uptimeBuffer_.filter(function(e){return e}).length/this.uptimeBuffer_.length:null}},{key:"dispose",value:function(){p("Disposing..."),this.removeAllListeners(),this.uptimeBuffer_=[],this.uptimeCheck_&&clearInterval(this.uptimeCheck_)}}]),t}(u);_.States={READY:-1,CONNECTING:0,CONNECTED:1,CLOSING:2,CLOSED:3},_.Events={CONNECTING:"_connecting",CONNECTING_ERROR:"_connecting_error",CONNECTED:"_connected",CLOSED:"_closed",ERROR:"_error"},e.exports=_},function(e,t){e.exports=require("uws")},function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=function(){function e(){var t=this,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=r.handler,o=void 0===i?function(){}:i,s=r.onExpire,c=void 0===s?function(){}:s,a=r.timeout,u=void 0===a?0:a;n(this,e),this.resolve_=null,this.reject_=null,this.timeout_=null,this.onExpire_=c,this.isFinished_=!1,this.promise=new Promise(function(e,n){t.resolve_=e,t.reject_=n;try{o(t)}catch(e){t.reject(e)}}),u>0&&(this.timeout_=setTimeout(this.expire.bind(this),u))}return r(e,[{key:"resolve",value:function(e){this.isFinished_||(this.isFinished_=!0,this.clearTimeout_(),this.resolve_(e))}},{key:"reject",value:function(e){this.isFinished_||(this.isFinished_=!0,this.clearTimeout_(),this.reject_(e))}},{key:"expire",value:function(){this.isFinished_=!0,this.clearTimeout_(),this.onExpire_(),this.reject_(new Error("Timeout exceed"))}},{key:"then",value:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return this.promise.then.apply(this.promise,t)}},{key:"catch",value:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return this.promise.catch.apply(this.promise,t)}},{key:"clearTimeout_",value:function(){this.timeout_&&(clearTimeout(this.timeout_),this.timeout_=null)}}]),e}();e.exports=i},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var s=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),c=n(12),a=n(2),u=n(11),l=n(13),h=n(0),d=h.generateDummyId,f=n(1),p=function(e){function t(e){var n=e.name,o=e.payload,s=e.id,c=e.err;r(this,t);var a=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return a.name=n,a.payload=o,a.id=s,a.err=c,a.isResponded_=!1,a}return o(t,e),s(t,null,[{key:"parse",value:function(e){try{var n=JSON.parse(e);return new t({name:n.n,payload:n.p,err:n.e,id:n.i})}catch(e){throw new Error("Could not parse message.")}}}]),s(t,[{key:"setId",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:d();return this.id=e,e}},{key:"createResponse",value:function(e,n){return new t({name:"_r",payload:n,err:e,id:this.id})}},{key:"resolve",value:function(e){var t=this;return c(this.id)?console.warn("[line] A message without an id cannot be resolved."):this.isResponded_?console.warn("[line] This message has already been ended."):a(e)&&u(e.then)?void e.then(function(n){t.isResponded_=!0,t.emit("resolved",e)}).catch(function(e){t.isResponded_=!0,t.emit("rejected",e)}):(this.isResponded_=!0,void this.emit("resolved",e))}},{key:"reject",value:function(e){return c(this.id)?console.warn("[line] A message without an id cannot be rejected."):this.isResponded_?console.warn("[line] This message has already been ended."):(this.isResponded_=!0,void this.emit("rejected",e))}},{key:"toString",value:function(){try{var e={n:this.name};return c(this.payload)||(e.p=this.payload),c(this.id)||(e.i=this.id),c(this.err)||(e.e=this.err),JSON.stringify(e)}catch(e){throw new Error("Could not stringify message.")}}},{key:"dispose",value:function(){var e=this,t=this.eventNames();t.forEach(function(t){return e.removeAllListeners(t)})}}]),t}(f);p.Names={RESPONSE:"_r",HANDSHAKE:"_h",PING:"_p"},p.ReservedNames=l(p.Names),e.exports=p},function(e,t){e.exports=require("debug")},function(e,t){e.exports=require("lodash/assign")},function(e,t){e.exports=require("lodash/debounce")},function(e,t){e.exports=require("lodash/isBoolean")},function(e,t){e.exports=require("lodash/isFunction")},function(e,t){e.exports=require("lodash/isUndefined")},function(e,t){e.exports=require("lodash/values")},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var s=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),c=function e(t,n,r){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,n);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,n,r)}if("value"in i)return i.value;var s=i.get;if(void 0!==s)return s.call(r)};global.WebSocket=n(4);var a=n(3),u=function(e){function t(){return r(this,t),i(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return o(t,e),s(t,[{key:"bindEvents_",value:function(){var e=this;this.ws_.on("open",this.onOpen.bind(this)),this.ws_.on("error",this.onError.bind(this)),this.ws_.on("close",function(t,n){0==t&&(t=1005),e.onClose({code:t,reason:n})}),this.ws_.on("message",function(t){e.onMessage({data:t})})}},{key:"send_",value:function(e){var t=this;return new Promise(function(n,r){t.ws_.send(e.toString(),function(e){return e?r(e):void n()})})}},{key:"onError",value:function(e){var n=this;e||(e={code:1006,reason:""}),c(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"onError",this).call(this),setTimeout(function(t){return n.onClose(e)})}}]),t}(a);e.exports=u}]);
//# sourceMappingURL=client-node.js.map