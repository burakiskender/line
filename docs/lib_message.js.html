<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/message.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Client.html">Client</a><ul class='members'><li data-type='member'><a href="Client.html#.Events">Events</a></li><li data-type='member'><a href="Client.html#.States">States</a></li></ul><ul class='methods'><li data-type='method'><a href="Client.html#connect">connect</a></li><li data-type='method'><a href="Client.html#disconnect">disconnect</a></li><li data-type='method'><a href="Client.html#ping">ping</a></li><li data-type='method'><a href="Client.html#send">send</a></li><li data-type='method'><a href="Client.html#sendWithoutResponse">sendWithoutResponse</a></li></ul></li><li><a href="Message.html">Message</a><ul class='methods'><li data-type='method'><a href="Message.html#reject">reject</a></li><li data-type='method'><a href="Message.html#resolve">resolve</a></li></ul></li><li><a href="Server.html">Server</a><ul class='members'><li data-type='member'><a href="Server.html#.Events">Events</a></li></ul><ul class='methods'><li data-type='method'><a href="Server.html#broadcast">broadcast</a></li><li data-type='method'><a href="Server.html#getConnectionById">getConnectionById</a></li><li data-type='method'><a href="Server.html#getConnections">getConnections</a></li><li data-type='method'><a href="Server.html#getRoom">getRoom</a></li><li data-type='method'><a href="Server.html#getRoomsOf">getRoomsOf</a></li><li data-type='method'><a href="Server.html#removeFromAllRooms">removeFromAllRooms</a></li><li data-type='method'><a href="Server.html#start">start</a></li><li data-type='method'><a href="Server.html#stop">stop</a></li></ul></li><li><a href="ServerConnection.html">ServerConnection</a><ul class='members'><li data-type='member'><a href="ServerConnection.html#.Events">Events</a></li><li data-type='member'><a href="ServerConnection.html#.States">States</a></li></ul><ul class='methods'><li data-type='method'><a href="ServerConnection.html#close">close</a></li><li data-type='method'><a href="ServerConnection.html#getRooms">getRooms</a></li><li data-type='method'><a href="ServerConnection.html#joinRoom">joinRoom</a></li><li data-type='method'><a href="ServerConnection.html#leaveRoom">leaveRoom</a></li><li data-type='method'><a href="ServerConnection.html#ping">ping</a></li><li data-type='method'><a href="ServerConnection.html#send">send</a></li><li data-type='method'><a href="ServerConnection.html#sendWithoutResponse">sendWithoutResponse</a></li><li data-type='method'><a href="ServerConnection.html#setId">setId</a></li></ul></li><li><a href="ServerRoom.html">ServerRoom</a><ul class='methods'><li data-type='method'><a href="ServerRoom.html#add">add</a></li><li data-type='method'><a href="ServerRoom.html#broadcast">broadcast</a></li><li data-type='method'><a href="ServerRoom.html#getConnectionById">getConnectionById</a></li><li data-type='method'><a href="ServerRoom.html#getConnections">getConnections</a></li><li data-type='method'><a href="ServerRoom.html#getConnectionsCount">getConnectionsCount</a></li><li data-type='method'><a href="ServerRoom.html#remove">remove</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">lib/message.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const isUndefined = require('lodash/isUndefined');
const isObject = require('lodash/isObject');
const isFunction = require('lodash/isFunction');
const values = require('lodash/values');
const {generateDummyId} = require('./utils');
const EventEmitterExtra = require('event-emitter-extra/dist/commonjs.modern');


/**
 * Message class.
 *
 * @private
 * @class Message
 * @extends {EventEmitterExtra}
 * @property {string} name Event name
 * @property {?any} payload Message payload.
 */
class Message extends EventEmitterExtra {
    static parse(raw) {
        try {
            const data = JSON.parse(raw);
            return new Message({
                name: data.n,
                payload: data.p,
                err: data.e,
                id: data.i
            });
        } catch(err) {
            throw new Error(`Could not parse message.`);
        }
    }

    constructor({name, payload, id, err}) {
        super();

        this.name = name;
        this.payload = payload;
        this.id = id;
        this.err = err;

        this.isResponded_ = false;
    }

    setId(id = generateDummyId()) {
        this.id = id;
        return id;
    }

    createResponse(err, payload) {
        return new Message({name: '_r', payload, err, id: this.id});
    }


    /**
     * Resolves the message with sending a response back. If event source
     * does not expecting a response, you don't need to call these methods.
     * @param {any=} payload
     */
    resolve(payload) {
        if (isUndefined(this.id))
            return console.warn('[line] A message without an id cannot be resolved.');

        if (this.isResponded_)
            return console.warn('[line] This message has already been ended.');

        // If thenable
        if (isObject(payload) &amp;&amp; isFunction(payload.then)) {
            payload
                .then(response => {
                    this.isResponded_ = true;
                    this.emit('resolved', payload);
                })
                .catch(err => {
                    this.isResponded_ = true;
                    this.emit('rejected', err);
                });

            return;
        }

        this.isResponded_ = true;
        this.emit('resolved', payload);
    }


    /**
     * Rejects the message, with sending error response back to event source.
     * @param {any=} err
     */
    reject(err) {
        if (isUndefined(this.id))
            return console.warn('[line] A message without an id cannot be rejected.');

        if (this.isResponded_)
            return console.warn('[line] This message has already been ended.');

        this.isResponded_ = true;
        this.emit('rejected', err);
    }

    toString() {
        try {
            const data = {n: this.name};

            if (!isUndefined(this.payload))
                data.p = this.payload;

            if (!isUndefined(this.id))
                data.i = this.id;

            if (!isUndefined(this.err))
                data.e = this.err;

            return JSON.stringify(data);
        } catch(err) {
            throw new Error(`Could not stringify message.`);
        }
    }

    dispose() {
        const events = this.eventNames();
        events.forEach(event => this.removeAllListeners(event));
    }
}


Message.Names = {
    RESPONSE: '_r',
    HANDSHAKE: '_h',
    PING: '_p'
};


Message.ReservedNames = values(Message.Names);


module.exports = Message;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Wed Dec 28 2016 12:02:46 GMT+0300 (+03) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
